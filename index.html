<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Roleplay-chat.com | No-login AI Roleplay</title>
  <meta name="description" content="Create a character and start a no-login AI roleplay chat instantly. General and +18 Uncensored options available." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#000000" />

  <!-- Open Graph -->
  <meta property="og:title" content="roleplay-chat.com | No-login AI Roleplay" />
  <meta property="og:description" content="Create a character and start a no-login AI roleplay chat instantly." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://roleplay-chat.com/" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="roleplay-chat.com | No-login AI Roleplay" />
  <meta name="twitter:description" content="Create a character and start a no-login AI roleplay chat instantly." />

  <!-- Favicon (placeholder paths - replace with your real assets when ready) -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  <!-- Rounded, commercial-free font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- PayPal SDK (for in-page popup/overlay checkout). Note: The "buttons" flow opens PayPal in an overlay/mini-window. -->
  <script src="https://www.paypal.com/sdk/js?client-id=ASts4hxcd4-DkLEL8b-PbbawSaCD4G5pQiuJM9aZYawixhxWbQ2upSru10WQNZa4HzCqHUcGC8Z1RIrW&currency=USD&intent=capture"></script>

  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --muted:rgba(255,255,255,.75);
      --muted2:rgba(255,255,255,.55);
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --border:rgba(255,255,255,.14);
      --focus:rgba(255,255,255,.25);
      --danger:#ff4d4d;
      --ok:#52ff9a;
      --shadow: 0 14px 36px rgba(0,0,0,.55);

      --radius: 16px;
      --radius2: 22px;

      /* default chat font color selection (preview) */
      --chatColor: #000000;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(900px 600px at 10% 0%, rgba(255,255,255,.06), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(255,255,255,.05), transparent 60%),
                  var(--bg);
      color: var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.35;
    }

    a{ color:inherit; }
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 14px 26px;
    }
    .shell{
      width: min(860px, 100%);
      display:grid;
      gap: 14px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:center;
      padding-top: 8px;
    }
    .logo{
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 700;
      letter-spacing: .3px;
      font-size: clamp(30px, 6vw, 48px);
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      user-select:none;
    }

    .logoRole{
  color: #ffcc00; /* dark yellow */
}


.logoDot{
  color: rgba(255,255,255,.95); /* keep white */
  font-size: 0.5em;            /* half size */
  vertical-align: baseline;
}

    .logo span{ opacity:.95; }
    .sub{
      text-align:center;
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .cardHead h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .badge{
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      white-space:nowrap;
    }

    .cardBody{ padding: 14px 16px 16px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 720px){
      .grid{
        grid-template-columns: 1fr 1fr;
        gap: 12px 14px;
      }
      .span2{ grid-column: span 2; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }

    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.45);
      color: var(--fg);
      outline: none;
      transition: .15s ease;
      font-size: 14px;
    }
    textarea{ resize: vertical; min-height: 92px; max-height: 240px; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,255,255,.30);
      box-shadow: 0 0 0 4px rgba(255,255,255,.08);
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pillGroup{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }
    .pill{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      transition:.15s ease;
    }
    .pill:hover{ background: rgba(255,255,255,.06); }
    .pill input{ width:auto; margin:0; }
    .pill small{ color: var(--muted2); }

    .hint{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted2);
    }

    .colors{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    @media (min-width:720px){
      .colors{ grid-template-columns: repeat(8, minmax(0, 1fr)); }
    }
    .swatch{
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition:.15s ease;
    }
    .swatch:hover{ transform: translateY(-1px); }
    .swatch[aria-selected="true"]{
      outline: 3px solid rgba(255,255,255,.18);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .swatch .check{
      position:absolute;
      inset:auto 8px 8px auto;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      display:none;
    }
    .swatch[aria-selected="true"] .check{ display:block; }

    .preview{
      display:flex;
      gap: 12px;
      align-items:center;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
    }
    .avatar{
      width: 52px; height: 52px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .bubble{
      flex:1;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 13px;
      color: var(--muted);
    }
    .bubble b{
      color: var(--fg);
      font-weight: 700;
      font-family: "Baloo 2", Inter, sans-serif;
    }
    .bubble .accent{
      color: var(--fg);
      font-weight: 700;
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: 3px;
      text-decoration-color: var(--chatColor);
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 14px;
    }

    .btn{
      width: 100%;
      padding: 14px 14px;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 16px;
      background: rgba(255,255,255,.10);
      color: var(--fg);
      font-weight: 800;
      cursor:pointer;
      transition:.15s ease;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .btn:hover{ background: rgba(255,255,255,.14); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }

    .btnPrimary{
      background: rgba(255,255,255,.16);
    }

    .note{
      font-size: 12px;
      color: var(--muted2);
      margin: 10px 2px 0;
    }

    /* In-page "Next page" view (no full page load) */
    .view{ display:none; }
    .view.active{ display:block; }

    /* Chat placeholder */
    .chatShell{
      display:grid;
      gap: 12px;
    }
    .chatTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
    }
    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      white-space:nowrap;
    }
    .chatBox{
      height: min(62vh, 520px);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      padding: 14px;
      overflow:auto;
    }
    .chatMsg{
      display:flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items:flex-start;
    }

    /* (4) ADDED: user messages on the right */
    .chatMsg.me{
      flex-direction: row-reverse;
    }
    .chatMsg.me .text{
      text-align: right;
    }

    .chatMsg .who{
      width: 38px; height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      flex: 0 0 auto;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      color: var(--muted);
    }
    .chatMsg .who img{ width:100%; height:100%; object-fit:cover; display:block; }
    .chatMsg .text{
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      max-width: 78%;
      color: var(--fg);
      font-size: 14px;
    }
    .chatMsg .text .name{
      font-weight: 800;
      font-family: "Baloo 2", Inter, sans-serif;
      color: var(--chatColor);
    }
    .chatControls{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .chatInput{
      flex:1;
      padding: 14px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.45);
      color: var(--fg);
      font-size: 14px;
    }
    .sendBtn{
      width: 52px;
      height: 52px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.12);
      color: var(--fg);
      cursor:pointer;
      font-weight: 900;
      font-size: 18px;
    }

    /* Paywall modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      z-index: 9999;
    }
    .modalOverlay.active{ display:flex; }
    .modal{
      width: min(520px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(10,10,10,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .modalHeader h3{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .xBtn{
      border:none;
      background: rgba(255,255,255,.08);
      color: var(--fg);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.14);
    }
    .modalBody{ padding: 14px 16px 16px; }
    .warn{
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 10px;
    }
    .error{
      margin-top: 10px;
      font-size: 12px;
      color: var(--danger);
      display:none;
    }
    .ok{
      margin-top: 10px;
      font-size: 12px;
      color: var(--ok);
      display:none;
    }

    footer{
      text-align:center;
      font-size: 12px;
      color: rgba(255,255,255,.45);
      padding: 10px 0 4px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">

      <header>
        <div class="logo">
  <span class="logoRole">Roleplay-chat</span><span class="logoDot">.com</span>
</div>

      </header>
      <div class="sub">No-login AI roleplay. Create a character, then chat instantly.</div>

      <!-- VIEW 1: Character setup -->
      <section id="viewSetup" class="card view active" aria-label="Character creation">
        <div class="cardHead">
          <h2>Character Setup</h2>
          <div class="badge">Mobile-first ‚Ä¢ Dark UI</div>
        </div>

        <div class="cardBody">
          <form id="characterForm" class="grid" autocomplete="off">
            <div>
              <label for="name">Name <span style="color: rgba(255,255,255,.55);">(required)</span></label>
              <input id="name" name="name" type="text" required maxlength="40" placeholder="e.g., Luna, Detective Gray, Captain Nova" />
              <div class="hint">Tip: A short, memorable name works best.</div>
            </div>

            <div>
              <label for="age">Age (18‚Äì200)</label>
              <select id="age" name="age" required></select>
            </div>

            <div>
              <label for="gender">Gender</label>
              <select id="gender" name="gender" required>
                <option value="Man">Man</option>
                <option value="Woman">Woman</option>
                <option value="None">None</option>
                <option value="Gay">Gay</option>
                <option value="Lesbian">Lesbian</option>
                <option value="Bi">Bi</option>
                <option value="Trans man">Trans man</option>
                <option value="Trans woman">Trans woman</option>
              </select>
            </div>

            <div>
              <label for="language">Language</label>
              <select id="language" name="language" required>
                <option value="English">English</option>
                <option value="Spanish">Espa√±ol</option>
                <option value="Chinese">‰∏≠Êñá</option>
                <option value="French">Fran√ßais</option>
                <option value="Portuguese">Portugu√™s</option>
                <option value="German">Deutsch</option>
                <option value="Japanese">Êó•Êú¨Ë™û</option>
                <option value="Italian">Italiano</option>
                <option value="Korean">ÌïúÍµ≠Ïñ¥</option>
                <option value="Dutch">Nederlands</option>
                <option value="Russian">–†—É—Å—Å–∫–∏–π</option>
                <option value="Arabic">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                <option value="Swedish">Svenska</option>
                <option value="Norwegian">Norsk</option>
                <option value="Danish">Dansk</option>
              </select>
            </div>

            <div class="span2">
              <label for="personality">Personality (up to 300 chars)</label>
              <textarea id="personality" name="personality" maxlength="300" placeholder="Describe their personality, tone, quirks, and boundaries..."></textarea>
              <div class="hint"><span id="pCount">0</span>/300</div>
            </div>

            <div class="span2">
              <label for="scenario">Place & Situation (up to 300 chars)</label>
              <textarea id="scenario" name="scenario" maxlength="300" placeholder="Where are you? What's happening? Set the scene..."></textarea>
              <div class="hint"><span id="sCount">0</span>/300</div>
            </div>

            <div class="span2">
              <label>Font Color (8 options, default black)</label>
              <div class="colors" id="colorGrid" role="listbox" aria-label="Font color options"></div>
              <div class="hint">This color will be used to display the character name in chat.</div>
            </div>

            <div class="span2">
              <label for="avatar">Profile Photo (optional)</label>
              <input id="avatar" name="avatar" type="file" accept="image/*" />
              <div class="hint">PNG/JPG/WebP recommended.</div>
            </div>

            <div class="span2">
              <label>Chat Option</label>
              <div class="pillGroup" role="radiogroup" aria-label="Chat option">
                <label class="pill">
                  <input type="radio" name="tier" value="general" checked />
                  <div>
                    <div><b>General</b> <small>(free)</small></div>
                    <div class="hint" style="margin:4px 0 0;">Uses DeepSeek model.</div>
                  </div>
                </label>

                <label class="pill">
                  <input type="radio" name="tier" value="uncensored" />
                  <div>
                    <div><b>+18 Uncensored</b> <small>($2)</small></div>
                    <div class="hint" style="margin:4px 0 0;">Pay once, then uses Venice Uncensored.</div>
                  </div>
                </label>
              </div>
            </div>

            <div class="span2">
              <div class="preview" aria-label="Preview">
                <div class="avatar" id="avatarPreview">
                  <span>üôÇ</span>
                </div>
                <div class="bubble">
                  <div><b>Preview</b></div>
                  <div style="margin-top:6px;">
                    <span class="accent" id="namePreview" style="--chatColor: var(--chatColor);">Your character</span>
                    <span style="color: var(--muted2);"> will appear like this in chat.</span>
                  </div>
                </div>
              </div>

              <div class="actions">
                <button id="createBtn" class="btn btnPrimary" type="submit">Create</button>
              </div>
              <div class="note">
                No login. Your character is kept per-tab using sessionStorage.
              </div>
            </div>
          </form>
        </div>
      </section>

      <!-- VIEW 2: Chat (placeholder) -->
      <section id="viewChat" class="card view" aria-label="Chat">
        <div class="cardHead">
          <h2>Chat</h2>
        </div>

        <div class="cardBody">
          <div class="chatShell">
            <div class="chatTop">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <div class="chip" id="chipName">Name: ‚Äî</div>
                <div class="chip" id="chipLang">Language: ‚Äî</div>
                <div class="chip" id="chipTier">Tier: ‚Äî</div>
              </div>
              <button class="xBtn" id="resetBtn" type="button" title="Create new character">New</button>
            </div>

            <div class="chatBox" id="chatBox">
              <div class="chatMsg">
                <div class="who" id="chatAvatar">üôÇ</div>
                <div class="text">
                  <div class="name" id="chatName">Character</div>
                  <div style="margin-top:6px; color: rgba(255,255,255,.78);">
                    hi
                  </div>
                </div>
              </div>
            </div>

            <div class="chatControls">
              <input class="chatInput" id="chatInput" type="text" placeholder="Type a message (placeholder)..." />
              <button class="sendBtn" id="sendBtn" type="button" title="Send">‚û§</button>
            </div>

            <div class="note">
              Note: Payment is simulated until you connect a server-side PayPal order flow (recommended) or a safer client flow.
            </div>
          </div>
        </div>
      </section>

      <footer>¬© <span id="year"></span> roleplay-chat.com</footer>
    </div>
  </div>

  <!-- Paywall Modal -->
  <div id="payModal" class="modalOverlay" role="dialog" aria-modal="true" aria-label="+18 Uncensored payment">
    <div class="modal">
      <div class="modalHeader">
        <h3>Unlock +18 Uncensored ($2)</h3>
        <button class="xBtn" id="closePay" type="button">Close</button>
      </div>
      <div class="modalBody">
        <p class="warn">
          After payment, you‚Äôll be routed into chat using the Venice Uncensored model.<br/>
          (For production, create orders on your server for best security.)
        </p>

        <div id="paypalButtons"></div>

        <div class="ok" id="payOk">Payment successful. Entering chat‚Ä¶</div>
        <div class="error" id="payErr">Payment failed or cancelled. Please try again.</div>
      </div>
    </div>
  </div>

  <script>
    // --------- Helpers
    const $ = (q) => document.querySelector(q);
    const $$ = (q) => Array.from(document.querySelectorAll(q));

    const DEFAULT_TITLE = "roleplay-chat.com | No-login AI Roleplay"; // (3) ADDED
    document.title = DEFAULT_TITLE; // (3) ADDED

    const viewSetup = $("#viewSetup");
    const viewChat = $("#viewChat");

    const form = $("#characterForm");
    const nameInput = $("#name");
    const personality = $("#personality");
    const scenario = $("#scenario");
    const pCount = $("#pCount");
    const sCount = $("#sCount");

    const ageSelect = $("#age");
    const avatarInput = $("#avatar");
    const avatarPreview = $("#avatarPreview");
    const namePreview = $("#namePreview");

    const payModal = $("#payModal");
    const closePay = $("#closePay");
    const payOk = $("#payOk");
    const payErr = $("#payErr");

    const modelBadge = $("#modelBadge");
    const chipName = $("#chipName");
    const chipLang = $("#chipLang");
    const chipTier = $("#chipTier");
    const chatName = $("#chatName");
    const chatAvatar = $("#chatAvatar");
    const resetBtn = $("#resetBtn");

    const STORAGE_KEY = "roleplay-chat_session_v1";

    // Colors: bright & readable colors
    const colorOptions = [
      { name: "White", value: "#ffffff" },
      { name: "Sky Blue", value: "#5cc8ff" },
      { name: "Mint", value: "#5cffc4" },
      { name: "Lime", value: "#b8ff5c" },
      { name: "Yellow", value: "#ffd95c" },
      { name: "Orange", value: "#ff9f5c" },
      { name: "Pink", value: "#ff7ac8" },
      { name: "Violet", value: "#b68cff" },
    ];

    let selectedColor = colorOptions[0].value;
    let selectedColorName = colorOptions[0].name;

    // --------- Init: age options 18..200
    for (let i = 18; i <= 200; i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      ageSelect.appendChild(opt);
    }
    ageSelect.value = "18";

    // --------- Init: colors grid
    const colorGrid = $("#colorGrid");
    function renderColors(){
      colorGrid.innerHTML = "";
      colorOptions.forEach((c, idx) => {
        const div = document.createElement("div");
        div.className = "swatch";
        div.style.background = c.value;
        div.setAttribute("role", "option");
        div.setAttribute("tabindex", "0");
        div.setAttribute("aria-label", c.name);
        div.setAttribute("aria-selected", String(c.value === selectedColor));
        div.dataset.value = c.value;
        div.dataset.name = c.name;
        div.innerHTML = `<div class="check">‚úì</div>`;
        div.addEventListener("click", () => chooseColor(c.value, c.name));
        div.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " "){
            e.preventDefault();
            chooseColor(c.value, c.name);
          }
        });
        colorGrid.appendChild(div);
      });
      applyPreviewColor();
    }
    function chooseColor(val, name){
      selectedColor = val;
      selectedColorName = name;
      $$("#colorGrid .swatch").forEach(el => el.setAttribute("aria-selected", String(el.dataset.value === selectedColor)));
      applyPreviewColor();
    }
    function applyPreviewColor(){
      document.documentElement.style.setProperty("--chatColor", selectedColor);
      namePreview.textContent = nameInput.value.trim() || "Your character";
    }
    renderColors();

    // --------- Counters
    function updateCounts(){
      pCount.textContent = String(personality.value.length);
      sCount.textContent = String(scenario.value.length);
    }
    personality.addEventListener("input", updateCounts);
    scenario.addEventListener("input", updateCounts);
    updateCounts();

    // --------- Name preview
    nameInput.addEventListener("input", applyPreviewColor);

    // --------- Avatar preview
    let avatarDataUrl = "";
    avatarInput.addEventListener("change", () => {
      const file = avatarInput.files && avatarInput.files[0];
      if (!file){
        avatarDataUrl = "";
        avatarPreview.innerHTML = "<span>üôÇ</span>";
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        avatarDataUrl = reader.result;
        avatarPreview.innerHTML = `<img alt="Profile preview" src="${avatarDataUrl}">`;
      };
      reader.readAsDataURL(file);
    });

    // --------- View switching
    function show(view){
      viewSetup.classList.remove("active");
      viewChat.classList.remove("active");
      view.classList.add("active");
      window.scrollTo({ top: 0, behavior: "smooth" });

      // (3) ADDED: when returning to setup, restore default title
      if (view === viewSetup) document.title = DEFAULT_TITLE;
    }

    // --------- Save & load (tab-scoped)
    function saveSession(data){
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    function loadSession(){
      try{
        const raw = sessionStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }
    function clearSession(){
      sessionStorage.removeItem(STORAGE_KEY);
    }

    // --------- Fill chat view
    function enterChat(session){
      // Basic display
      const tierLabel = session.tier === "uncensored" ? "+18 Uncensored ($2)" : "General";
      const modelLabel = session.tier === "uncensored" ? "Venice Uncensored" : "DeepSeek";

      chipName.textContent = "Name: " + session.name;
      chipLang.textContent = "Language: " + session.language;
      chipTier.textContent = "Tier: " + tierLabel;

      chatName.textContent = session.name;
      document.documentElement.style.setProperty("--chatColor", session.fontColor || "#000000");

      // (3) ADDED: tab title uses character name
      document.title = session.name + " | roleplay-chat.com";

      if (session.avatarDataUrl){
        chatAvatar.innerHTML = `<img alt="Profile" src="${session.avatarDataUrl}">`;
      } else {
        chatAvatar.textContent = "üôÇ";
      }

      show(viewChat);
    }

    // --------- Paywall modal controls
    function openPayModal(){
      payErr.style.display = "none";
      payOk.style.display = "none";
      payModal.classList.add("active");
    }
    function closePayModal(){
      payModal.classList.remove("active");
    }
    closePay.addEventListener("click", closePayModal);
    payModal.addEventListener("click", (e) => {
      if (e.target === payModal) closePayModal();
    });

    // --------- PayPal Buttons (client-only demo)
    function mountPayPalButtons(onSuccess){
      const container = $("#paypalButtons");
      container.innerHTML = "";
      if (!window.paypal){
        payErr.textContent = "PayPal SDK failed to load. Please refresh and try again.";
        payErr.style.display = "block";
        return;
      }

      window.paypal.Buttons({
        style: { layout: "vertical", shape: "pill" },
        createOrder: (data, actions) => {
          return actions.order.create({
            purchase_units: [{
              description: "roleplay-chat.com +18 Uncensored",
              amount: { value: "2.00", currency_code: "USD" }
            }]
          });
        },
        onApprove: async (data, actions) => {
          try{
            await actions.order.capture();
            payOk.style.display = "block";
            payErr.style.display = "none";
            setTimeout(() => {
              closePayModal();
              onSuccess();
            }, 600);
          }catch(err){
            payErr.textContent = "Payment capture failed. Please try again.";
            payErr.style.display = "block";
            payOk.style.display = "none";
          }
        },
        onCancel: () => {
          payErr.textContent = "Payment cancelled.";
          payErr.style.display = "block";
          payOk.style.display = "none";
        },
        onError: () => {
          payErr.textContent = "Payment error. Please try again.";
          payErr.style.display = "block";
          payOk.style.display = "none";
        }
      }).render("#paypalButtons");
    }

    // =========================
    // ADDED: chat.ts connection
    // =========================
    const chatInput = $("#chatInput");
    const sendBtn = $("#sendBtn");

    let chatHistory = []; // {role:"user"|"assistant", content:string}
    const PAYMENT_KEY = "roleplay-chat_paid_v1";
    let paymentStatus = sessionStorage.getItem(PAYMENT_KEY) || "unpaid"; // refresh-safe within this tab

    function appendMsg(role, content){
      const msg = document.createElement("div");
      msg.className = "chatMsg";

      // (4) ADDED: user messages on right
      if (role === "user") msg.classList.add("me");

      const who = document.createElement("div");
      who.className = "who";
      who.innerHTML = (role === "assistant")
        ? (chatAvatar.innerHTML || "üôÇ")
        : "<span>YOU</span>";

      const bubble = document.createElement("div");
      bubble.className = "text";

      if (role === "assistant"){
        // (2) CHANGED: assistant content color uses --chatColor too
        bubble.innerHTML = `<div class="name" style="color: var(--chatColor);">${chatName.textContent}</div>
                            <div style="margin-top:6px; color: var(--chatColor); white-space:pre-wrap;"></div>`;
      } else {
        bubble.innerHTML = `<div style="font-weight:800; margin-bottom:6px;">You</div>
                            <div style="color: rgba(255,255,255,.86); white-space:pre-wrap;"></div>`;
      }

      bubble.querySelector("div:last-child").textContent = content;

      msg.appendChild(who);
      msg.appendChild(bubble);
      $("#chatBox").appendChild(msg);
      $("#chatBox").scrollTop = $("#chatBox").scrollHeight;
    }

    async function sendToChatApi(text){
      const session = loadSession();
      if (!session) throw new Error("No session");

      const tier = session.tier === "uncensored" ? "uncensored" : "general";

      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          tier,
          paymentStatus: tier === "uncensored" ? paymentStatus : undefined,
          character: {
            name: session.name,
            age: Number(session.age),
            gender: session.gender,
            language: session.language,
            personality: session.personality,
            scenario: session.scenario
          },
          message: text,
          history: chatHistory
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data?.error || `Request failed (${res.status})`);
      }
      return data.reply;
    }

    async function handleSend(){
      const text = chatInput.value.trim();
      if (!text) return;

      chatInput.value = "";
      appendMsg("user", text);
      chatHistory.push({ role: "user", content: text });

      try{
        sendBtn.disabled = true;
        chatInput.disabled = true;

        const reply = await sendToChatApi(text);

        appendMsg("assistant", reply);
        chatHistory.push({ role: "assistant", content: reply });
      }catch(e){
        appendMsg("assistant", `Error: ${String(e.message || e)}`);
      }finally{
        sendBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
      }
    }

    sendBtn.addEventListener("click", handleSend);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        handleSend();
      }
    });
    // =========================
    // END chat.ts connection
    // =========================

    // --------- Submit flow
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const name = nameInput.value.trim();
      if (!name){
        nameInput.focus();
        return;
      }

      const tier = (form.querySelector('input[name="tier"]:checked') || {}).value || "general";

      const session = {
        name,
        age: ageSelect.value,
        gender: $("#gender").value,
        language: $("#language").value,
        personality: personality.value.trim(),
        scenario: scenario.value.trim(),
        fontColor: selectedColor,
        fontColorName: selectedColorName,
        avatarDataUrl: avatarDataUrl || "",
        tier,
        createdAt: Date.now()
      };

      saveSession(session);

      if (tier === "general"){
        enterChat(session);
      } else {
        openPayModal();
        mountPayPalButtons(() => {
          paymentStatus = "paid";
          sessionStorage.setItem(PAYMENT_KEY, "paid"); // refresh-safe

          const latest = loadSession();
          if (latest){
            latest.tier = "uncensored";
            saveSession(latest);
            enterChat(latest);
          }
        });
      }
    });

    // (1) CHANGED: New opens a fresh setup tab (clears session in that new tab only)
    resetBtn.addEventListener("click", () => {
      window.open("/?new=1", "_blank");
    });

    // (1) ADDED: if opened as /?new=1, clear this tab's session and payment state
    const params = new URLSearchParams(window.location.search);
    if (params.get("new") === "1"){
      clearSession();
      sessionStorage.removeItem(PAYMENT_KEY);
      paymentStatus = "unpaid";
      show(viewSetup);
    }

    // --------- Restore session if exists
    const existing = loadSession();
    if (existing && existing.name){
      enterChat(existing);
    }

    // Footer year
    $("#year").textContent = String(new Date().getFullYear());
  </script>
</body>
</html>

