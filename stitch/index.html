<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Stitch | roleplay-chat.com</title>
  <meta name="theme-color" content="#000000" />

  <!-- Fonts (same as main) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --muted:rgba(255,255,255,.75);
      --muted2:rgba(255,255,255,.55);
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14);
      --shadow: 0 14px 36px rgba(0,0,0,.55);
      --radius2: 22px;

      --gold:#ffcc00;
      --hot:#FF69B4;
      --ok:#38d16a;
      --warn:#ffcc00;
      --bad:#ff5b5b;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }

    body{
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(255,255,255,.05), transparent 60%),
        var(--bg);
      color: var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.35;
    }

    a{ color:inherit; }

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 18px 14px 26px;
    }

    .shell{
      width: min(860px, 100%);
      display:grid;
      gap: 14px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 4px 6px 0;
      gap: 12px;
    }

    .logo{
      text-decoration: none;
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 700;
      letter-spacing: .3px;
      font-size: clamp(16px, 3.6vw, 24px);
      padding: 5px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.45);
      user-select:none;
      white-space: nowrap;
    }

    .logoRole{ color: #ffcc00; }
    .logoDot{
      color: rgba(255,255,255,.95);
      font-size: 0.5em;
      vertical-align: baseline;
    }

    .shareWrap{
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }

    .bookmarkHint{
      font-size: 10px;
      line-height: 1.1;
      text-align: right;
      color: rgba(255,255,255,.55);
      user-select: none;
      white-space: nowrap;
    }

    .shareBtn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:.15s ease;
      flex: 0 0 auto;
      padding: 0;
    }
    .shareBtn:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }
    .shareBtn:active{ transform: translateY(0px); }

    .shareBtn svg{
      width: 16px;
      height: 16px;
      fill: none;
      stroke: rgba(255,255,255,.92);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* ✅ Info 버튼: 노란 글로우 */
    #infoBtn{
      border-color: rgba(255, 204, 0, .55);
      box-shadow:
        0 0 0 1px rgba(255, 204, 0, .25),
        0 0 18px rgba(255, 204, 0, .35),
        0 0 34px rgba(255, 204, 0, .22),
        var(--shadow);
    }
    #infoBtn:hover{
      border-color: rgba(255, 204, 0, .75);
      box-shadow:
        0 0 0 1px rgba(255, 204, 0, .35),
        0 0 22px rgba(255, 204, 0, .45),
        0 0 44px rgba(255, 204, 0, .28),
        var(--shadow);
    }

    .infoMenu{
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      background: rgba(10,10,10,.92);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 6px;
      display: none;
      z-index: 99999;
    }
    .infoMenu.active{ display: block; }

    .infoMenu a{
      display: block;
      padding: 10px 10px;
      border-radius: 12px;
      text-decoration: none;
      color: rgba(255,255,255,.92);
      font-size: 13px;
    }
    .infoMenu a:hover{ background: rgba(255,255,255,.08); }

    .sub{
      text-align:center;
      margin-top: 0px;
      color: var(--muted);
      font-size: 12px;
    }

    /* =========================
       Stitch page content
       ========================= */
    .content{
      display:grid;
      gap: 12px;
      padding: 6px;
    }

    .hero{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      padding: 16px 14px;
    }

    .title{
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 700;
      letter-spacing: .2px;
      font-size: clamp(18px, 5.2vw, 28px);
      margin: 0 0 6px;
      line-height: 1.05;
    }

    .subtitle{
      margin: 0 0 10px;
      color: rgba(255,255,255,.70);
      font-size: 13px;
    }

    .ctaLinkRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .textLink{
      text-decoration: none; /* no underline */
      color: rgba(255,255,255,.92);
      font-weight: 700;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      transition: .15s ease;
      user-select:none;
      white-space: nowrap;
    }
    .textLink:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.20);
    }

    .mp4Only{
      font-size: 12px;
      color: rgba(255,255,255,.65);
      padding-left: 2px;
      display:flex;
      align-items:center;
      gap: 6px;
      user-select:none;
    }
    .dot{
      width: 7px; height: 7px; border-radius: 99px;
      background: rgba(255,204,0,.9);
      box-shadow: 0 0 16px rgba(255,204,0,.35);
      display:inline-block;
    }

    .panel{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:hidden;
    }

    .panelHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panelTitle{
      font-weight: 800;
      letter-spacing: .2px;
      margin: 0;
      font-size: 14px;
      color: rgba(255,255,255,.92);
    }

    .hint{
      margin: 0;
      font-size: 12px;
      color: rgba(255,255,255,.60);
    }

    /* Slots layout:
       - Mobile: 2 columns grid (so 10 slots => 2 x 5)
       - Desktop: single-row horizontal strip (continuous to the right)
    */
    .slots{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (min-width: 740px){
      .slots{
        display:flex;
        gap: 10px;
        overflow-x: auto;
        padding-bottom: 6px;
        scroll-snap-type: x mandatory;
      }
      .slots::-webkit-scrollbar{ height: 8px; }
      .slots::-webkit-scrollbar-thumb{
        background: rgba(255,255,255,.12);
        border-radius: 999px;
      }
    }

    .slot{
      position: relative;
      border-radius: 18px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      height: 130px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      transition: .15s ease;
      user-select:none;
      cursor:pointer;
    }

    @media (min-width: 740px){
      .slot{
        width: 170px;
        flex: 0 0 auto;
        scroll-snap-align: start;
      }
    }

    .slot:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.24);
    }

    .slot.dragover{
      border-color: rgba(255,204,0,.65);
      box-shadow:
        0 0 0 1px rgba(255,204,0,.20),
        0 0 28px rgba(255,204,0,.22),
        0 10px 26px rgba(0,0,0,.35);
      background: rgba(255,204,0,.06);
    }

    .slotNumber{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 800;
      font-size: 44px;
      color: rgba(255,255,255,.10);
      pointer-events:none;
    }

    .slotLabel{
      position:absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      pointer-events:none;
    }

    .slotText{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.15;
      max-width: 75%;
    }

    .slotBadge{
      font-size: 11px;
      font-weight: 800;
      color: rgba(255,255,255,.88);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .plusSlot{
      border-style: solid;
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.02);
    }
    .plusIcon{
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 900;
      font-size: 44px;
      color: rgba(255,255,255,.75);
      text-shadow: 0 0 18px rgba(255,255,255,.12);
      transform: translateY(-2px);
    }
    .plusHelp{
      position:absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.62);
      text-align:center;
      pointer-events:none;
    }

    .thumb{
      position:absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.05) contrast(1.02);
      opacity: 0;
      transition: opacity .15s ease;
    }
    .slot.filled .thumb{ opacity: 1; }
    .slot.filled{
      border-style: solid;
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.02);
    }

    .removeBtn{
      position:absolute;
      top: 8px;
      right: 8px;
      width: 30px;
      height: 30px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:.15s ease;
      z-index: 5;
    }
    .removeBtn:hover{ background: rgba(0,0,0,.55); transform: translateY(-1px); }
    .removeBtn svg{
      width: 14px; height: 14px;
      stroke: rgba(255,255,255,.9);
      stroke-width: 2.2;
      stroke-linecap: round;
    }

    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .stitchBtn{
      appearance:none;
      border: 1px solid rgba(255,204,0,.55);
      background: rgba(255,204,0,.10);
      color: rgba(255,255,255,.95);
      font-weight: 900;
      letter-spacing: .2px;
      border-radius: 16px;
      padding: 12px 14px;
      cursor:pointer;
      transition:.15s ease;
      box-shadow:
        0 0 0 1px rgba(255,204,0,.18),
        0 0 22px rgba(255,204,0,.22),
        var(--shadow);
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
    }
    .stitchBtn:hover{ transform: translateY(-1px); background: rgba(255,204,0,.14); }
    .stitchBtn:active{ transform: translateY(0px); }
    .stitchBtn[disabled]{
      cursor:not-allowed;
      opacity:.65;
      transform:none !important;
      filter: grayscale(.2);
    }

    .status{
      flex: 1 1 240px;
      min-height: 42px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
      color: rgba(255,255,255,.80);
      font-size: 12px;
    }

    .pill{
      font-size: 11px;
      font-weight: 900;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      white-space: nowrap;
    }
    .pill.ok{ border-color: rgba(56,209,106,.35); background: rgba(56,209,106,.10); }
    .pill.warn{ border-color: rgba(255,204,0,.35); background: rgba(255,204,0,.10); }
    .pill.bad{ border-color: rgba(255,91,91,.35); background: rgba(255,91,91,.10); }

    .progressBar{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      width: 100%;
      margin-top: 10px;
      display:none;
    }
    .progressFill{
      height: 100%;
      width: 0%;
      background: rgba(255,204,0,.70);
      box-shadow: 0 0 22px rgba(255,204,0,.28);
    }

    .note{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.55);
      line-height: 1.35;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.85);
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">

      <header>
        <!-- ✅ 2줄 스택 컨테이너 -->
        <div style="display:block; width:100%;">

          <!-- ✅ 1줄: 기존 헤더 내용 -->
          <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
            <a href="https://roleplay-chat.com" target="_blank" rel="noopener noreferrer" class="logo">
              <span class="logoRole">Roleplay-chat</span><span class="logoDot">.com</span>
            </a>

            <!-- ✅ 공유 영역 묶기 -->
            <div class="shareWrap">
              <div class="bookmarkHint">
                Bookmark<br>&amp; Share
              </div>

              <button class="shareBtn" id="shareBtn" type="button" aria-label="Share" title="Share">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="18" cy="5" r="3"></circle>
                  <circle cx="6" cy="12" r="3"></circle>
                  <circle cx="18" cy="19" r="3"></circle>
                  <path d="M8.6 13.5l6.8 3.9"></path>
                  <path d="M15.4 6.6L8.6 10.5"></path>
                </svg>
              </button>

              <!-- ✅ Info 버튼(최우측) -->
              <button class="shareBtn" id="infoBtn" type="button" aria-label="Info" title="Info">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="12" cy="12" r="9"></circle>
                  <path d="M12 10.5v6"></path>
                  <circle cx="12" cy="7.5" r="1"></circle>
                </svg>
              </button>

              <!-- ✅ Info 메뉴 -->
              <div class="infoMenu" id="infoMenu" role="menu" aria-label="Info menu">
                <a href="https://chat-with-stranger.com" target="_blank" rel="noopener noreferrer" style="color: #FF69B4; font-weight: bold; text-decoration: none;">Chat with stranger</a>
                <a href="https://roleplay-chat.com/human" target="_blank" rel="noopener noreferrer" style="color: #FFD700; font-weight: bold; text-decoration: none;">Chat with real human</a>
                <a href="https://roleplay-chat.com" target="_blank" rel="noopener noreferrer">Home</a>
                <a href="https://roleplay-chat.com/how" target="_blank" rel="noopener noreferrer">How to use</a>
                <a href="https://roleplay-chat.com/about" target="_blank" rel="noopener noreferrer">About</a>
                <a href="https://roleplay-chat.com/pricing" target="_blank" rel="noopener noreferrer">Pricing</a>
                <a href="https://roleplay-chat.com/all_access_purchase" target="_blank" rel="noopener noreferrer">All-access pass</a>
                <a href="https://roleplay-chat.com/policy" target="_blank" rel="noopener noreferrer">Policy</a>
                <a href="https://roleplay-chat.com/faq" target="_blank" rel="noopener noreferrer">FAQ</a>
                <a href="mailto:showmetheaitools@gmail.com">Contact</a>
                <a href="https://2048global.com" target="_blank" rel="noopener noreferrer" style="color: #FFD700; font-weight: bold; text-decoration: none;">Game</a>
                <a href="https://roleplay-chat.com/VPN" target="_blank" rel="noopener noreferrer" style="color: #FFD700; font-weight: bold; text-decoration: none;">VPN</a>
              </div>
            </div>
          </div>

          <!-- ✅ 2줄: Chatango 라인(오른쪽) -->
          <div align="right">
            <sup>
              <a href="https://roleplay-chat.com/human" target="_blank" style="text-decoration:none">
                <font size="1" color="#ffcc00"><b>Live user chat</b></font>
              </a>
            </sup>

            <script
              id="cid0020000430144912743"
              data-cfasync="false"
              async
              src="https://st.chatango.com/js/gz/emb.js"
              style="width:200px;height:300px;"
            >
              {"handle":"roleplay-chat-com","arch":"js","styles":{"a":"000000","b":100,"c":"FFFFFF","d":"FFFFFF","k":"000000","l":"000000","m":"000000","n":"FFFFFF","p":"10","q":"000000","r":100,"cv":1,"cvfntsz":"10px","cvbg":"000000","cvfg":"ffcc00","cvw":49,"cvh":18}}
            </script>
          </div>

        </div>
      </header>

      <div class="sub">Create the most human-like character, Enjoy roleplay.<br>no-login. Private & Safe.</div>

      <!-- =========================
           Stitch content
           ========================= -->
      <div class="content">

        <div class="hero">
          <h1 class="title">Stitch your chat-made clips into one long video</h1>
          <p class="subtitle">Extend the videos you made in Video Chat mode by stitching them together.</p>

          <div class="ctaLinkRow">
            <a class="textLink" href="https://roleplay-chat.com" target="_blank" rel="noopener noreferrer">
              Make videos while chatting →
            </a>

            <div class="mp4Only" title="MP4 only">
              <span class="dot"></span>
              MP4 only
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHead">
            <div>
              <p class="panelTitle">Drop clips in order (2 to 10)</p>
              <p class="hint">Tap a slot to upload, or drag & drop MP4 files into slots.</p>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="pill warn" id="countPill">0 / 10</span>
            </div>
          </div>

          <div class="slots" id="slots"></div>

          <div class="controls">
            <button class="stitchBtn" id="stitchBtn" type="button">
              <span style="font-family:'Baloo 2', Inter, sans-serif; font-size: 18px; letter-spacing:.2px;">Stitch</span>
              <span class="pill" id="enginePill">Ready</span>
            </button>

            <div class="status" id="statusBox" aria-live="polite">
              <span class="pill warn" id="statusPill">Tip</span>
              <div id="statusText">Add at least <b>2</b> MP4 clips, then press <b>Stitch</b>. Your stitched video will download automatically.</div>
            </div>
          </div>

          <div class="progressBar" id="progressBar" aria-hidden="true">
            <div class="progressFill" id="progressFill"></div>
          </div>

          <div class="note">
            Notes:
            <br>• Stitching runs in your browser (no upload to server).
            <br>• If a clip fails, re-export it as MP4 (H.264 + AAC) and try again.
            <br>• Desktop: clips flow to the right (scroll). Mobile: grid stays finger-friendly.
          </div>
        </div>

      </div>

    </div>
  </div>

  <!-- FFmpeg (loaded only when needed in JS, but script tag keeps it simple) -->
<script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.min.js"></script>

  <script data-cfasync="false">
    // =========================
    // Header: Share + Info menu (unchanged behavior)
    // =========================
    const shareBtn = document.querySelector("#shareBtn");
    if (shareBtn){
      shareBtn.addEventListener("click", async () => {
        const url = window.location.href;
        try{
          if (navigator.share){
            await navigator.share({ title: document.title, url });
          }else{
            await navigator.clipboard.writeText(url);
            shareBtn.title = "Copied!";
            setTimeout(() => (shareBtn.title = "Share"), 900);
          }
        }catch(e){
          // user cancelled / blocked
        }
      });
    }

    const infoBtn = document.querySelector("#infoBtn");
    const infoMenu = document.querySelector("#infoMenu");

    function closeInfoMenu(){
      if (infoMenu) infoMenu.classList.remove("active");
    }

    if (infoBtn && infoMenu){
      infoBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        infoMenu.classList.toggle("active");
      });

      infoMenu.addEventListener("click", (e) => {
        e.stopPropagation();
      });

      document.addEventListener("click", closeInfoMenu);
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeInfoMenu();
      });
    }

    // =========================
    // Stitch UI + Logic
    // =========================
    const MAX = 10;

    const slotsEl = document.getElementById("slots");
    const stitchBtn = document.getElementById("stitchBtn");
    const statusBox = document.getElementById("statusBox");
    const statusText = document.getElementById("statusText");
    const statusPill = document.getElementById("statusPill");
    const countPill = document.getElementById("countPill");
    const enginePill = document.getElementById("enginePill");

    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");

    // state
    let openCount = 2; // starts with 2 slots
    const files = new Array(MAX).fill(null);  // File objects
    const urls  = new Array(MAX).fill(null);  // blob URLs for previews

    function setStatus(kind, msgHtml){
      statusPill.classList.remove("ok","warn","bad");
      if (kind === "ok") statusPill.classList.add("ok");
      if (kind === "warn") statusPill.classList.add("warn");
      if (kind === "bad") statusPill.classList.add("bad");
      statusPill.textContent = (kind === "ok" ? "Done" : kind === "bad" ? "Error" : "Tip");
      statusText.innerHTML = msgHtml;
    }

    function setProgress(pct){
      const clamped = Math.max(0, Math.min(100, pct));
      progressBar.style.display = "block";
      progressFill.style.width = clamped.toFixed(1) + "%";
    }

    function hideProgress(){
      progressBar.style.display = "none";
      progressFill.style.width = "0%";
    }

    function countFilled(){
      return files.filter(Boolean).length;
    }

    function updateCountPill(){
      countPill.textContent = `${countFilled()} / ${MAX}`;
    }

    function revokeUrl(i){
      if (urls[i]){
        URL.revokeObjectURL(urls[i]);
        urls[i] = null;
      }
    }

    function clearSlot(i){
      files[i] = null;
      revokeUrl(i);
      render();
      updateCountPill();
    }

    function isMp4(file){
      // Most reliable: mime type may be empty on some devices, so also check extension.
      const nameOk = (file && typeof file.name === "string" && file.name.toLowerCase().endsWith(".mp4"));
      const typeOk = (file && typeof file.type === "string" && file.type.toLowerCase() === "video/mp4");
      return !!(typeOk || nameOk);
    }

    function setFile(i, file){
      if (!file) return;
      if (!isMp4(file)){
        setStatus("bad", "MP4 only. Please select a <span class='kbd'>.mp4</span> file.");
        return;
      }
      files[i] = file;
      revokeUrl(i);
      urls[i] = URL.createObjectURL(file);
      setStatus("warn", "Nice. Add more clips (2 to 10), then press <b>Stitch</b>.");
      render();
      updateCountPill();
    }

    function makeSlot(i){
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.setAttribute("role","button");
      slot.setAttribute("tabindex","0");
      slot.setAttribute("aria-label", `Slot ${i+1} - upload MP4`);

      const number = document.createElement("div");
      number.className = "slotNumber";
      number.textContent = String(i+1);

      // hidden file input
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "video/mp4,.mp4";
      input.style.display = "none";

      input.addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) setFile(i, f);
        input.value = ""; // allow re-selecting same file
      });

      slot.addEventListener("click", () => input.click());
      slot.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          input.click();
        }
      });

      // drag & drop
      slot.addEventListener("dragover", (e) => {
        e.preventDefault();
        slot.classList.add("dragover");
      });
      slot.addEventListener("dragleave", () => slot.classList.remove("dragover"));
      slot.addEventListener("drop", (e) => {
        e.preventDefault();
        slot.classList.remove("dragover");
        const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) setFile(i, f);
      });

      const label = document.createElement("div");
      label.className = "slotLabel";

      const left = document.createElement("div");
      left.className = "slotText";
      left.innerHTML = "Tap or drop<br><span style='color:rgba(255,255,255,.55)'>MP4</span>";

      const right = document.createElement("div");
      right.className = "slotBadge";
      right.textContent = "MP4";

      label.appendChild(left);
      label.appendChild(right);

      slot.appendChild(number);
      slot.appendChild(label);
      slot.appendChild(input);

      // If filled: show thumbnail video + remove button
      if (files[i]){
        slot.classList.add("filled");

        const vid = document.createElement("video");
        vid.className = "thumb";
        vid.src = urls[i];
        vid.muted = true;
        vid.playsInline = true;
        vid.preload = "metadata";
        vid.loop = true;
        vid.autoplay = true;

        // Some mobile browsers block autoplay; that's fine. Still shows first frame after metadata.
        vid.addEventListener("loadedmetadata", () => {
          // Try to seek a tiny bit to get a visible frame quickly
          try { vid.currentTime = Math.min(0.1, (vid.duration || 1) / 10); } catch {}
        });

        const remove = document.createElement("button");
        remove.type = "button";
        remove.className = "removeBtn";
        remove.setAttribute("aria-label", `Remove clip from slot ${i+1}`);
        remove.innerHTML = `
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        `;

        remove.addEventListener("click", (e) => {
          e.stopPropagation();
          clearSlot(i);
          setStatus("warn", "Removed. You can re-add a clip anytime.");
        });

        slot.appendChild(vid);
        slot.appendChild(remove);

        // overlay label becomes subtle
        left.innerHTML = "Clip ready<br><span style='color:rgba(255,255,255,.55)'>Tap to replace</span>";
        right.textContent = "OK";
      }

      return slot;
    }

    function makePlusSlot(){
      const slot = document.createElement("div");
      slot.className = "slot plusSlot";
      slot.setAttribute("role","button");
      slot.setAttribute("tabindex","0");
      slot.setAttribute("aria-label","Add another slot");

      const plus = document.createElement("div");
      plus.className = "plusIcon";
      plus.textContent = "+";

      const help = document.createElement("div");
      help.className = "plusHelp";
      help.innerHTML = "Add slot<br><span style='color:rgba(255,255,255,.45)'>up to 10</span>";

      function add(){
        if (openCount < MAX){
          openCount += 1;
          setStatus("warn", `Slot <b>${openCount}</b> added. Keep going (up to 10).`);
          render();
        }
      }

      slot.addEventListener("click", add);
      slot.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          add();
        }
      });

      slot.appendChild(plus);
      slot.appendChild(help);
      return slot;
    }

    function render(){
      slotsEl.innerHTML = "";

      // Render opened slots
      for (let i = 0; i < openCount; i++){
        slotsEl.appendChild(makeSlot(i));
      }

      // Add "+" slot if more available
      if (openCount < MAX){
        slotsEl.appendChild(makePlusSlot());
      }
    }

    render();
    updateCountPill();

    // =========================
    // Stitch with FFmpeg.wasm
    // =========================
    let ffmpeg = null;
let ffmpegLoading = false;

async function ensureFFmpeg(){
  if (ffmpeg) return ffmpeg;

  if (ffmpegLoading){
    while (ffmpegLoading) await new Promise(r => setTimeout(r, 120));
    return ffmpeg;
  }

  ffmpegLoading = true;
  enginePill.textContent = "Loading…";
  enginePill.classList.remove("ok","bad","warn");
  enginePill.classList.add("warn");
  setStatus("warn", "Loading Stitch engine… (first run can take a moment)");

  try{
    const API = window.FFmpeg;
    if (!API) throw new Error("FFmpeg library not loaded (window.FFmpeg missing).");

    const { FFmpeg, fetchFile } = API;
    if (typeof FFmpeg !== "function") throw new Error("FFmpeg class not found.");

    ffmpeg = new FFmpeg();

    ffmpeg.on("progress", ({ progress }) => {
      setProgress((progress || 0) * 100);
    });

    await ffmpeg.load();
    ffmpeg._fetchFile = fetchFile;

    enginePill.textContent = "Engine ready";
    enginePill.classList.remove("warn","bad");
    enginePill.classList.add("ok");
    setStatus("warn", "Engine ready. Press <b>Stitch</b> to combine your clips.");
    return ffmpeg;
  }catch(err){
    console.error("FFmpeg load error:", err);
    enginePill.textContent = "Engine failed";
    enginePill.classList.remove("warn","ok");
    enginePill.classList.add("bad");
    setStatus("bad", "Failed to load the Stitch engine. Open Console for details.");
    throw err;
  }finally{
    ffmpegLoading = false;
  }
}


    function getOrderedFiles(){
      // Only take opened slots, keep order
      const arr = [];
      for (let i = 0; i < openCount; i++){
        if (files[i]) arr.push({ idx: i, file: files[i] });
      }
      return arr;
    }

    function downloadBlob(blob, filename){
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2500);
    }

    async function stitchNow(){
  const ordered = getOrderedFiles();
  if (ordered.length < 2){
    setStatus("bad", "You need at least <b>2</b> MP4 clips to Stitch.");
    return;
  }

  stitchBtn.disabled = true;
  hideProgress();
  setProgress(0);

  try{
    const ff = await ensureFFmpeg();

    setStatus("warn", "Preparing clips…");
    setProgress(2);

    // 1) write inputs
    const listLines = [];
    for (let n = 0; n < ordered.length; n++){
      const name = `input_${n+1}.mp4`;
      const data = await ff._fetchFile(ordered[n].file);
      await ff.writeFile(name, data);
      listLines.push(`file ${name}`);
    }
    await ff.writeFile("list.txt", new TextEncoder().encode(listLines.join("\n")));

    setStatus("warn", "Stitching… (this runs locally in your browser)");
    setProgress(6);

    // 2) stitch (re-encode for compatibility)
    await ff.exec([
      "-f","concat","-safe","0",
      "-i","list.txt",
      "-c:v","libx264","-preset","veryfast","-crf","23",
      "-c:a","aac","-b:a","192k",
      "-movflags","+faststart",
      "output.mp4"
    ]);

    const out = await ff.readFile("output.mp4");
    const blob = new Blob([out.buffer], { type: "video/mp4" });

    setStatus("ok", "Completed. Your stitched video is downloading now.");
    downloadBlob(blob, "stitched.mp4");

    // 3) cleanup (best-effort)
    try { await ff.deleteFile("output.mp4"); } catch {}
    try { await ff.deleteFile("list.txt"); } catch {}
    for (let n = 0; n < ordered.length; n++){
      try { await ff.deleteFile(`input_${n+1}.mp4`); } catch {}
    }

  }catch(err){
    console.error("Stitch error:", err);
    setStatus("bad", "Stitch failed. Open DevTools Console to see the exact FFmpeg error.");
  }finally{
    stitchBtn.disabled = false;
    setTimeout(() => hideProgress(), 1400);
  }
}


    stitchBtn.addEventListener("click", stitchNow);

    // Small quality-of-life: if user drops a file anywhere, put it into the first empty opened slot.
    document.addEventListener("dragover", (e) => e.preventDefault());
    document.addEventListener("drop", (e) => {
      // If dropping over a slot, slot handler already ran.
      if (!e.dataTransfer || !e.dataTransfer.files || !e.dataTransfer.files[0]) return;
      const f = e.dataTransfer.files[0];
      // If target is inside a slot, ignore.
      if (e.target && e.target.closest && e.target.closest(".slot")) return;

      // find first empty opened slot
      for (let i = 0; i < openCount; i++){
        if (!files[i]){
          setFile(i, f);
          break;
        }
      }
    });
  </script>
</body>
</html>







