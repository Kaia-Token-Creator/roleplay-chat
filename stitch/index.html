<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Stitch | roleplay-chat.com</title>
  <meta name="theme-color" content="#000000" />

  <!-- Fonts (same as main) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --muted:rgba(255,255,255,.75);
      --muted2:rgba(255,255,255,.55);
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14);
      --shadow: 0 14px 36px rgba(0,0,0,.55);
      --radius2: 22px;
      --yellow:#ffcc00;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }

    body{
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(255,255,255,.05), transparent 60%),
        var(--bg);
      color: var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.35;
    }

    a{ color:inherit; }

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 18px 14px 26px;
    }

    .shell{
      width: min(860px, 100%);
      display:grid;
      gap: 14px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 4px 6px 0;
      gap: 12px;
    }

    .logo{
      text-decoration: none;
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 700;
      letter-spacing: .3px;
      font-size: clamp(16px, 3.6vw, 24px);
      padding: 5px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.45);
      user-select:none;
      white-space: nowrap;
    }

    .logoRole{ color: var(--yellow); }
    .logoDot{
      color: rgba(255,255,255,.95);
      font-size: 0.5em;
      vertical-align: baseline;
    }

    .shareWrap{
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }

    .bookmarkHint{
      font-size: 10px;
      line-height: 1.1;
      text-align: right;
      color: rgba(255,255,255,.55);
      user-select: none;
      white-space: nowrap;
    }

    .shareBtn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:.15s ease;
      flex: 0 0 auto;
      padding: 0;
    }
    .shareBtn:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }
    .shareBtn:active{ transform: translateY(0px); }

    .shareBtn svg{
      width: 16px;
      height: 16px;
      fill: none;
      stroke: rgba(255,255,255,.92);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* ✅ Info button: yellow glow */
    #infoBtn{
      border-color: rgba(255, 204, 0, .55);
      box-shadow:
        0 0 0 1px rgba(255, 204, 0, .25),
        0 0 18px rgba(255, 204, 0, .35),
        0 0 34px rgba(255, 204, 0, .22),
        var(--shadow);
    }
    #infoBtn:hover{
      border-color: rgba(255, 204, 0, .75);
      box-shadow:
        0 0 0 1px rgba(255, 204, 0, .35),
        0 0 22px rgba(255, 204, 0, .45),
        0 0 44px rgba(255, 204, 0, .28),
        var(--shadow);
    }

    .infoMenu{
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      background: rgba(10,10,10,.92);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 6px;
      display: none;
      z-index: 99999;
    }
    .infoMenu.active{ display: block; }

    .infoMenu a{
      display: block;
      padding: 10px 10px;
      border-radius: 12px;
      text-decoration: none;
      color: rgba(255,255,255,.92);
      font-size: 13px;
    }
    .infoMenu a:hover{ background: rgba(255,255,255,.08); }

    .sub{
      text-align:center;
      margin-top: 0px;
      color: var(--muted);
      font-size: 12px;
    }

    /* =========================
       ✅ Stitch UI (same style family)
       ========================= */

    .stitchCard{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow: hidden;
      padding: 16px;
    }

    .title{
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 700;
      letter-spacing: .2px;
      font-size: clamp(20px, 4.2vw, 30px);
      margin: 0 0 6px 0;
      text-align: center;
    }

    .subtitle{
      margin: 0 0 10px 0;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }

    .linkRow{
      text-align: center;
      margin: 0 0 14px 0;
      font-size: 13px;
    }
    .linkRow a{
      color: rgba(255,255,255,.92);
      text-decoration: none;
      padding: 2px 0;
      border-bottom: 1px solid transparent;
    }
    .linkRow a:hover{
      color: var(--yellow);
      border-bottom-color: rgba(255,204,0,.55);
    }

    .hint{
      text-align: center;
      color: rgba(255,255,255,.62);
      font-size: 12px;
      margin: 0 0 14px 0;
    }

    /* Slots layout:
       - Desktop: horizontal strip (scrollable), "+" at end
       - Mobile: 2 columns (so when 10 are visible -> 2x5)
    */
    .slotsWrap{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      padding: 12px;
    }

    .slotsRow{
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 6px;
      scrollbar-width: thin;
    }
    .slotsRow::-webkit-scrollbar{ height: 8px; }
    .slotsRow::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius: 999px; }
    .slotsRow::-webkit-scrollbar-track{ background: transparent; }

    @media (max-width: 640px){
      .slotsRow{
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        overflow: visible;
        padding-bottom: 0;
      }
    }

    .slot{
      width: 150px;
      min-width: 150px;
      height: 98px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      position: relative;
      cursor: pointer;
      user-select: none;
      transition: .12s ease;
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .slot:hover{ background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.28); transform: translateY(-1px); }
    .slot:active{ transform: translateY(0px); }

    @media (max-width: 640px){
      .slot{
        width: 100%;
        min-width: 0;
      }
    }

    .slotNum{
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 11px;
      color: rgba(255,255,255,.45);
      font-weight: 600;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.10);
      padding: 3px 7px;
      border-radius: 999px;
      backdrop-filter: blur(6px);
    }

    .slotLabel{
      text-align: center;
      padding: 0 10px;
      color: rgba(255,255,255,.68);
      font-size: 12px;
      line-height: 1.2;
    }

    .plusSlot{
      border-style: solid;
      border-color: rgba(255,204,0,.26);
      background: rgba(255,204,0,.06);
    }
    .plusSlot:hover{
      border-color: rgba(255,204,0,.45);
      background: rgba(255,204,0,.10);
    }
    .plusSlot .plus{
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 700;
      font-size: 28px;
      color: rgba(255,204,0,.95);
      text-shadow: 0 0 18px rgba(255,204,0,.22);
    }
    .plusSlot .plusSub{
      margin-top: -6px;
      font-size: 11px;
      color: rgba(255,255,255,.66);
    }

    .thumb{
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.05) contrast(1.02);
    }

    .slotOverlay{
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,.70), rgba(0,0,0,0) 55%);
      opacity: 1;
      pointer-events: none;
    }

    .slotMeta{
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 9px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      pointer-events: none;
    }

    .slotName{
      font-size: 11px;
      color: rgba(255,255,255,.92);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 78%;
    }

    .slotRemove{
      pointer-events: auto;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      width: 26px;
      height: 22px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      transition: .12s ease;
    }
    .slotRemove:hover{
      border-color: rgba(255,255,255,.28);
      background: rgba(0,0,0,.50);
    }

    .slot.dragOver{
      border-color: rgba(255,204,0,.70);
      background: rgba(255,204,0,.10);
    }

    .controls{
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .primaryBtn{
      border: 1px solid rgba(255,204,0,.55);
      background: rgba(255,204,0,.10);
      color: rgba(255,255,255,.95);
      border-radius: 16px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .2px;
      box-shadow:
        0 0 0 1px rgba(255, 204, 0, .18),
        0 0 18px rgba(255, 204, 0, .18),
        var(--shadow);
      transition: .15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .primaryBtn:hover{ background: rgba(255,204,0,.14); transform: translateY(-1px); }
    .primaryBtn:active{ transform: translateY(0px); }
    .primaryBtn:disabled{
      opacity: .45;
      cursor: not-allowed;
      transform: none;
      box-shadow: var(--shadow);
    }

    .miniNote{
      text-align:center;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      margin-top: 10px;
    }

    .status{
      text-align: center;
      font-size: 12px;
      color: rgba(255,255,255,.78);
      margin-top: 10px;
      min-height: 18px;
    }
    .status b{ color: rgba(255,255,255,.96); }
    .status .warn{ color: rgba(255,170,120,.95); }
    .status .ok{ color: rgba(180,255,200,.92); }

    .hiddenInput{ display:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">

      <header>
        <!-- ✅ 2-line stack container -->
        <div style="display:block; width:100%;">

          <!-- ✅ line 1: original header -->
          <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
            <a href="https://roleplay-chat.com" target="_blank" rel="noopener noreferrer" class="logo">
              <span class="logoRole">Roleplay-chat</span><span class="logoDot">.com</span>
            </a>

            <div class="shareWrap">
              <div class="bookmarkHint">
                Bookmark<br>&amp; Share
              </div>

              <button class="shareBtn" id="shareBtn" type="button" aria-label="Share" title="Share">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="18" cy="5" r="3"></circle>
                  <circle cx="6" cy="12" r="3"></circle>
                  <circle cx="18" cy="19" r="3"></circle>
                  <path d="M8.6 13.5l6.8 3.9"></path>
                  <path d="M15.4 6.6L8.6 10.5"></path>
                </svg>
              </button>

              <button class="shareBtn" id="infoBtn" type="button" aria-label="Info" title="Info">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="12" cy="12" r="9"></circle>
                  <path d="M12 10.5v6"></path>
                  <circle cx="12" cy="7.5" r="1"></circle>
                </svg>
              </button>

              <div class="infoMenu" id="infoMenu" role="menu" aria-label="Info menu">
                <a href="https://chat-with-stranger.com" target="_blank" rel="noopener noreferrer" style="color: #FF69B4; font-weight: bold; text-decoration: none;">Chat with stranger</a>
                <a href="https://roleplay-chat.com/human" target="_blank" rel="noopener noreferrer" style="color: #FFD700; font-weight: bold; text-decoration: none;">Chat with real human</a>
                <a href="https://roleplay-chat.com" target="_blank" rel="noopener noreferrer">Home</a>
                <a href="https://roleplay-chat.com/how" target="_blank" rel="noopener noreferrer">How to use</a>
                <a href="https://roleplay-chat.com/about" target="_blank" rel="noopener noreferrer">About</a>
                <a href="https://roleplay-chat.com/pricing" target="_blank" rel="noopener noreferrer">Pricing</a>
                <a href="https://roleplay-chat.com/all_access_purchase" target="_blank" rel="noopener noreferrer">All-access pass</a>
                <a href="https://roleplay-chat.com/policy" target="_blank" rel="noopener noreferrer">Policy</a>
                <a href="https://roleplay-chat.com/faq" target="_blank" rel="noopener noreferrer">FAQ</a>
                <a href="mailto:showmetheaitools@gmail.com">Contact</a>
                <a href="https://2048global.com" target="_blank" rel="noopener noreferrer" style="color: #FFD700; font-weight: bold; text-decoration: none;">Game</a>
                <a href="https://roleplay-chat.com/VPN" target="_blank" rel="noopener noreferrer" style="color: #FFD700; font-weight: bold; text-decoration: none;">VPN</a>
              </div>
            </div>
          </div>

          <!-- ✅ line 2: Chatango (right) -->
          <div align="right">
            <sup>
              <a href="https://roleplay-chat.com/human" target="_blank" style="text-decoration:none">
                <font size="1" color="#ffcc00"><b>Live user chat</b></font>
              </a>
            </sup>

            <script
              id="cid0020000430144912743"
              data-cfasync="false"
              async
              src="https://st.chatango.com/js/gz/emb.js"
              style="width:200px;height:300px;"
            >
              {"handle":"roleplay-chat-com","arch":"js","styles":{"a":"000000","b":100,"c":"FFFFFF","d":"FFFFFF","k":"000000","l":"000000","m":"000000","n":"FFFFFF","p":"10","q":"000000","r":100,"cv":1,"cvfntsz":"10px","cvbg":"000000","cvfg":"ffcc00","cvw":49,"cvh":18}}
            </script>
          </div>

        </div>
      </header>

      <div class="sub">Create the most human-like character, Enjoy roleplay.<br>no-login. Private &amp; Safe.</div>

      <!-- ✅ Stitch Page -->
      <section class="stitchCard" aria-label="Stitch">
        <h1 class="title">Stitch your chat videos into one long video</h1>
        <p class="subtitle">Extend your video-chat clips by stitching them together.</p>

        <div class="linkRow">
          <a href="https://roleplay-chat.com" target="_blank" rel="noopener noreferrer">→ Make videos while chatting</a>
        </div>

        <p class="hint">
          MP4 only • Up to 10 clips • Tap a slot or drag &amp; drop files
        </p>

        <div class="slotsWrap">
          <div class="slotsRow" id="slotsRow" aria-label="Upload slots"></div>
          <input class="hiddenInput" id="filePicker" type="file" accept="video/mp4" />
        </div>

        <div class="controls">
          <button class="primaryBtn" id="stitchBtn" type="button" disabled>
            <span style="color:rgba(255,204,0,.95); text-shadow:0 0 16px rgba(255,204,0,.22);">Stitch</span>
            <span style="font-weight:600; color:rgba(255,255,255,.75); font-size:12px;">(Download MP4)</span>
          </button>
        </div>

        <div class="status" id="status"></div>
        <div class="miniNote">
          Tip: keep clips compatible (same resolution / fps) for the fastest stitching.
        </div>
      </section>

    </div>
  </div>

  <!-- Share + Info menu (unchanged behavior) -->
  <script>
    // Share button
    const shareBtn = document.querySelector("#shareBtn");
    if (shareBtn){
      shareBtn.addEventListener("click", async () => {
        const url = window.location.href;
        try{
          if (navigator.share){
            await navigator.share({ title: document.title, url });
          }else{
            await navigator.clipboard.writeText(url);
            shareBtn.title = "Copied!";
            setTimeout(() => (shareBtn.title = "Share"), 900);
          }
        }catch(e){}
      });
    }

    // Info button dropdown
    const infoBtn = document.querySelector("#infoBtn");
    const infoMenu = document.querySelector("#infoMenu");

    function closeInfoMenu(){
      if (infoMenu) infoMenu.classList.remove("active");
    }

    if (infoBtn && infoMenu){
      infoBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        infoMenu.classList.toggle("active");
      });

      infoMenu.addEventListener("click", (e) => {
        e.stopPropagation();
      });

      document.addEventListener("click", closeInfoMenu);
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeInfoMenu();
      });
    }
  </script>

  <!-- ✅ Stitch logic -->
  <script type="module">
    // FFmpeg (ESM) via CDN — avoids window.FFmpeg UMD issues.
    // Note: If your site CSP blocks wasm/CDN, stitching will fail (we show a clear status message).
    import { FFmpeg } from "https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js";
    import { fetchFile } from "https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js";

    const MAX = 10;

    const slotsRow = document.getElementById("slotsRow");
    const filePicker = document.getElementById("filePicker");
    const stitchBtn = document.getElementById("stitchBtn");
    const statusEl = document.getElementById("status");

    /** Slots state
     *  { file: File|null, url: string|null, thumb: string|null, name: string|null }
     */
    let slots = Array.from({ length: 2 }, () => ({ file:null, url:null, thumb:null, name:null }));
    let openSlotsCount = 2; // how many upload slots are currently "active"
    let pickingIndex = null;

    // FFmpeg singleton
    const ffmpeg = new FFmpeg();
    let ffmpegLoaded = false;

    function setStatus(html){
      statusEl.innerHTML = html || "";
    }

    function enableStitchIfReady(){
      const files = slots.filter(s => s.file);
      stitchBtn.disabled = files.length < 2;
    }

    function revokeSlotURL(i){
      const s = slots[i];
      if (s && s.url){
        try{ URL.revokeObjectURL(s.url); }catch(e){}
      }
    }

    function truncateName(name, max=22){
      if (!name) return "";
      if (name.length <= max) return name;
      const ext = name.includes(".") ? "." + name.split(".").pop() : "";
      const base = name.replace(ext, "");
      return base.slice(0, Math.max(8, max - ext.length - 1)) + "…" + ext;
    }

    async function makeThumbFromVideo(file){
      // Create a tiny thumbnail from the first frame-ish
      return new Promise((resolve) => {
        const v = document.createElement("video");
        v.muted = true;
        v.playsInline = true;
        v.preload = "metadata";
        const url = URL.createObjectURL(file);
        v.src = url;

        const cleanup = () => {
          try{ URL.revokeObjectURL(url); }catch(e){}
          v.remove();
        };

        v.addEventListener("loadedmetadata", () => {
          // seek a bit in to avoid black frames
          const t = Math.min(0.12, Math.max(0, (v.duration || 0) * 0.02));
          try{ v.currentTime = t; }catch(e){ /* ignore */ }
        }, { once:true });

        v.addEventListener("seeked", () => {
          try{
            const canvas = document.createElement("canvas");
            canvas.width = 320;
            canvas.height = Math.round(320 * (v.videoHeight / Math.max(1, v.videoWidth)));
            const ctx = canvas.getContext("2d");
            ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
            const data = canvas.toDataURL("image/jpeg", 0.78);
            cleanup();
            resolve(data);
          }catch(e){
            cleanup();
            resolve(null);
          }
        }, { once:true });

        v.addEventListener("error", () => {
          cleanup();
          resolve(null);
        }, { once:true });
      });
    }

    function render(){
      slotsRow.innerHTML = "";

      // Render opened slots
      for (let i = 0; i < openSlotsCount; i++){
        const s = slots[i];
        const slot = document.createElement("div");
        slot.className = "slot";
        slot.dataset.index = String(i);

        // drag + drop visuals
        slot.addEventListener("dragover", (e) => {
          e.preventDefault();
          slot.classList.add("dragOver");
        });
        slot.addEventListener("dragleave", () => slot.classList.remove("dragOver"));
        slot.addEventListener("drop", async (e) => {
          e.preventDefault();
          slot.classList.remove("dragOver");
          const f = e.dataTransfer?.files?.[0];
          if (f) await handleFilePicked(i, f);
        });

        // click to pick file
        slot.addEventListener("click", () => {
          pickingIndex = i;
          filePicker.value = "";
          filePicker.click();
        });

        const num = document.createElement("div");
        num.className = "slotNum";
        num.textContent = String(i + 1);
        slot.appendChild(num);

        if (!s.file){
          const label = document.createElement("div");
          label.className = "slotLabel";
          label.innerHTML = `Tap or drop<br><span style="color:rgba(255,255,255,.48); font-size:11px;">MP4 clip</span>`;
          slot.appendChild(label);
        } else {
          if (s.thumb){
            const img = document.createElement("img");
            img.className = "thumb";
            img.alt = "Video thumbnail";
            img.src = s.thumb;
            slot.appendChild(img);
          }

          const overlay = document.createElement("div");
          overlay.className = "slotOverlay";
          slot.appendChild(overlay);

          const meta = document.createElement("div");
          meta.className = "slotMeta";

          const name = document.createElement("div");
          name.className = "slotName";
          name.title = s.name || "";
          name.textContent = truncateName(s.name || "clip.mp4");
          meta.appendChild(name);

          const rm = document.createElement("button");
          rm.type = "button";
          rm.className = "slotRemove";
          rm.title = "Remove";
          rm.textContent = "×";
          rm.addEventListener("click", (e) => {
            e.stopPropagation();
            clearSlot(i);
          });
          meta.appendChild(rm);

          slot.appendChild(meta);
        }

        slotsRow.appendChild(slot);
      }

      // Render "+" slot if can open more
      if (openSlotsCount < MAX){
        const plus = document.createElement("div");
        plus.className = "slot plusSlot";
        plus.title = "Add another slot";
        plus.addEventListener("click", () => {
          openSlotsCount = Math.min(MAX, openSlotsCount + 1);
          // Ensure slots array is long enough
          while (slots.length < openSlotsCount){
            slots.push({ file:null, url:null, thumb:null, name:null });
          }
          render();
          enableStitchIfReady();
        });

        const plusWrap = document.createElement("div");
        plusWrap.style.display = "grid";
        plusWrap.style.placeItems = "center";
        plusWrap.style.gap = "2px";

        const plusSign = document.createElement("div");
        plusSign.className = "plus";
        plusSign.textContent = "+";

        const plusSub = document.createElement("div");
        plusSub.className = "plusSub";
        plusSub.textContent = "Add slot";

        plusWrap.appendChild(plusSign);
        plusWrap.appendChild(plusSub);
        plus.appendChild(plusWrap);

        slotsRow.appendChild(plus);
      }
    }

    function clearSlot(i){
      revokeSlotURL(i);
      slots[i] = { file:null, url:null, thumb:null, name:null };
      setStatus("");
      render();
      enableStitchIfReady();
    }

    function isMp4(file){
      // accept strict MP4 only
      const nameOk = /\.mp4$/i.test(file.name || "");
      const typeOk = (file.type || "").toLowerCase() === "video/mp4";
      return nameOk || typeOk;
    }

    async function handleFilePicked(i, file){
      if (!isMp4(file)){
        setStatus(`<span class="warn">MP4 only.</span> Please select an .mp4 file.`);
        return;
      }

      setStatus(`Preparing thumbnail…`);
      revokeSlotURL(i);
      const url = URL.createObjectURL(file);

      // create thumb
      const thumb = await makeThumbFromVideo(file);

      slots[i] = {
        file,
        url,
        thumb,
        name: file.name || `clip_${i+1}.mp4`,
      };

      setStatus("");
      render();
      enableStitchIfReady();
    }

    filePicker.addEventListener("change", async () => {
      const f = filePicker.files && filePicker.files[0];
      if (!f) return;
      const idx = (pickingIndex === null) ? 0 : pickingIndex;
      pickingIndex = null;
      await handleFilePicked(idx, f);
    });

    async function ensureFFmpeg(){
      if (ffmpegLoaded) return true;
      setStatus(`Loading Stitch engine…`);

      try{
        // corePath points to the ffmpeg-core bundle (contains wasm)
        await ffmpeg.load({
  coreURL: "/assets/ffmpeg/ffmpeg-core.js",
  wasmURL: "/assets/ffmpeg/ffmpeg-core.wasm",
});
        ffmpegLoaded = true;
        setStatus("");
        return true;
      }catch(e){
        setStatus(`<span class="warn">Blocked by browser security policy.</span> FFmpeg (WASM) couldn't load.<br>
          Fix: allow the CDN and wasm in your CSP, or host the FFmpeg core files on your own domain.`);
        return false;
      }
    }

    function downloadBlob(blob, filename){
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    async function stitchNow(){
      const files = slots
        .slice(0, openSlotsCount)
        .map((s, idx) => ({ ...s, idx }))
        .filter(s => s.file);

      if (files.length < 2){
        setStatus(`<span class="warn">Add at least 2 clips</span> to stitch.`);
        return;
      }

      stitchBtn.disabled = true;

      const ok = await ensureFFmpeg();
      if (!ok){
        enableStitchIfReady();
        return;
      }

      try{
        setStatus(`Writing clips…`);

        // Clean any previous run files
        // (best-effort; ignore errors)
        try{ await ffmpeg.deleteFile("list.txt"); }catch(e){}
        try{ await ffmpeg.deleteFile("out.mp4"); }catch(e){}

        // Write inputs
        const inputNames = [];
        for (let k = 0; k < files.length; k++){
          const inName = `in_${String(k).padStart(2,"0")}.mp4`;
          inputNames.push(inName);
          // overwrite if exists
          try{ await ffmpeg.deleteFile(inName); }catch(e){}
          await ffmpeg.writeFile(inName, await fetchFile(files[k].file));
          setStatus(`Writing clips… <b>${k+1}/${files.length}</b>`);
        }

        // Concat demuxer (fast if codecs match)
        // list.txt format:
        // file 'in_00.mp4'
        // file 'in_01.mp4'
        const list = inputNames.map(n => `file '${n}'`).join("\n");
        await ffmpeg.writeFile("list.txt", new TextEncoder().encode(list));

        setStatus(`Stitching…`);

        // Use concat demuxer, try stream copy first (fast).
        // If it fails, fall back to re-encode.
        let usedReencode = false;

        try{
          await ffmpeg.exec([
            "-f", "concat",
            "-safe", "0",
            "-i", "list.txt",
            "-c", "copy",
            "-movflags", "+faststart",
            "out.mp4"
          ]);
        }catch(copyErr){
          usedReencode = true;
          setStatus(`Stitching… <span class="warn">re-encoding for compatibility</span>`);
          await ffmpeg.exec([
            "-f", "concat",
            "-safe", "0",
            "-i", "list.txt",
            "-r", "30",
            "-c:v", "libx264",
            "-preset", "veryfast",
            "-crf", "23",
            "-c:a", "aac",
            "-b:a", "160k",
            "-movflags", "+faststart",
            "out.mp4"
          ]);
        }

        setStatus(`<span class="ok"><b>Completed.</b></span> Downloading…${usedReencode ? " (compatibility mode)" : ""}`);

        const outData = await ffmpeg.readFile("out.mp4");
        const blob = new Blob([outData.buffer], { type: "video/mp4" });

        const stamp = new Date();
        const pad = (n) => String(n).padStart(2,"0");
        const filename = `stitched_${stamp.getFullYear()}-${pad(stamp.getMonth()+1)}-${pad(stamp.getDate())}_${pad(stamp.getHours())}${pad(stamp.getMinutes())}.mp4`;

        downloadBlob(blob, filename);

        // Clean up ffmpeg FS (best-effort)
        try{ await ffmpeg.deleteFile("list.txt"); }catch(e){}
        try{ await ffmpeg.deleteFile("out.mp4"); }catch(e){}
        for (const n of inputNames){
          try{ await ffmpeg.deleteFile(n); }catch(e){}
        }

        setTimeout(() => setStatus(`<span class="ok"><b>Completed.</b></span> Your download should have started.`), 400);

      }catch(err){
        setStatus(`<span class="warn">Stitch failed.</span> Try clips with the same resolution / fps, or fewer clips.`);
      }finally{
        enableStitchIfReady();
      }
    }

    stitchBtn.addEventListener("click", stitchNow);

    // Global drag & drop (drop anywhere -> fill first empty slot)
    window.addEventListener("dragover", (e) => e.preventDefault());
    window.addEventListener("drop", async (e) => {
      e.preventDefault();
      const f = e.dataTransfer?.files?.[0];
      if (!f) return;

      // find first empty slot among opened, else open next slot if possible
      let target = -1;
      for (let i = 0; i < openSlotsCount; i++){
        if (!slots[i].file){ target = i; break; }
      }
      if (target === -1){
        if (openSlotsCount < MAX){
          target = openSlotsCount;
          openSlotsCount++;
          while (slots.length < openSlotsCount){
            slots.push({ file:null, url:null, thumb:null, name:null });
          }
        } else {
          setStatus(`<span class="warn">All 10 slots are full.</span> Remove a clip first.`);
          return;
        }
      }

      await handleFilePicked(target, f);
    });

    // Init
    render();
    enableStitchIfReady();
    setStatus("");
  </script>
</body>
</html>

